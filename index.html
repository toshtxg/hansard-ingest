<h2 style="margin: 8px 0;">Frequency of Attendance in Parliament Sitting</h2>

<div>
  <label>Start Date <input id="start" type="date" value="2024-01-01"></label>
  <label>End Date <input id="end" type="date" value="2025-01-01"></label>
  <label>Minimum No. of Times Present <input id="min" type="number" value="10"></label>
  <button id="run">Run</button>
  <span id="status" style="margin-left:12px;"></span>
</div>

<canvas id="chart" height="120"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpudmN5bHJjYmh1Y3V1cHNyb2JtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NTEyMTQsImV4cCI6MjA4MjEyNzIxNH0.syKhLRe2KeioaQneh_z6ZiASnUyFV-akyaRsL9M1S-0";

const SUPABASE_BASE = "https://jnvcylrcbhucuupsrobm.supabase.co";
const RPC_PATH = "/rest/v1/rpc/attendance_summary";

async function fetchAttendance(payload) {
  const res = await fetch(`${SUPABASE_BASE}${RPC_PATH}`, {
    method: "POST",
    headers: {
      apikey: ANON_KEY,
      Authorization: `Bearer ${ANON_KEY}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

const valueLabelPlugin = {
  id: "valueLabelPlugin",
  afterDatasetsDraw(chart, args, pluginOptions) {
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const rows = pluginOptions.rows || [];

    ctx.save();
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillStyle = "#111";
    ctx.textBaseline = "middle";

    meta.data.forEach((bar, i) => {
      const r = rows[i] || {};
      const count = (r.count_present ?? "");
      const pct = (r.percentage_present != null) ? (Number(r.percentage_present) * 100).toFixed(1) + "%" : "";
      const label = `${count} (${pct})`;

      // Place text slightly to the right of the bar end
      const x = bar.x + 6;
      const y = bar.y;
      ctx.fillText(label, x, y);
    });

    ctx.restore();
  }
};

let chart;
async function run() {
  const statusEl = document.getElementById("status");
  try {
    statusEl.textContent = "Loading…";

    const payload = {
      start_date: document.querySelector("#start").value,
      end_date: document.querySelector("#end").value,
      min_present: Number(document.querySelector("#min").value)
    };

    const rows = await fetchAttendance(payload);

    if (!Array.isArray(rows) || rows.length === 0) {
      if (chart) chart.destroy();
      statusEl.textContent = "No rows returned.";
      return;
    }

    // Sort by percentage ascending (so best attendance appears at the bottom)
    rows.sort((a, b) => Number(a.percentage_present) - Number(b.percentage_present));

    const labels = rows.map(r => r.mp_name_cleaned);
    const values = rows.map(r => Number(r.percentage_present));

    // Make the canvas taller when there are many MPs
    const canvas = document.getElementById("chart");
    canvas.height = Math.max(100, rows.length * 10);

    if (chart) chart.destroy();
    chart = new Chart(canvas, {
      type: "bar",
      plugins: [valueLabelPlugin],
      data: {
        labels,
        datasets: [{
          label: "% present",
          data: values,
          maxBarThickness: 20,
          barThickness: 20,
          categoryPercentage: 0.2,
          barPercentage: 0.9
        }]
      },
      options: {
        indexAxis: "y",
        plugins: {
          title: {
            display: true,
            text: "Frequency of Attendance in Parliament Sitting",
            padding: { top: 8, bottom: 8 }
          },
          legend: { display: true },
          layout: { padding: { right: 8 } },
          valueLabelPlugin: { rows }
        },
        scales: {
          x: {
            display: false,
            min: 0,
            max: 2,
            grid: {
              display: false
            }
          },
          y: {
            grid: {
              display: false
            }
          }
        }
      }
    });

    statusEl.textContent = `Loaded ${rows.length} MPs.`;
  } catch (e) {
    console.error(e);
    const msg = (e && e.message) ? e.message : String(e);
    statusEl.textContent = "Error — see console.";
    alert(msg);
  }
}

document.querySelector("#run").addEventListener("click", run);
run();
</script>